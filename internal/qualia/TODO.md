# Qualia Package TODO

SPDX-License-Identifier: LicenseRef-Internal-Use-Only
SPDX-FileCopyrightText: 2025 Jumping Quail Solutions

## üöÄ High Priority

### Architecture & DI
- [x] Introduce `PsiModel` interface and make `HierarchicalBayesianModel` implement it
- [x] Add simple DI: `ModelFactory` and `ServiceLocator` for wiring
- [ ] Introduce abstract base classes where useful (e.g., `AbstractAuditSink`, `AbstractModel`)
- [x] DI configuration via environment: select `AuditSink` (console/file/http/jdbc) and params
- [ ] Unit tests: factory creation paths and service locator bindings

### Core Model Implementation
- [ ] **Complete MCMC inference in `HierarchicalBayesianModel`**
  - [ ] Integrate HMC/NUTS sampler library (e.g., Stan4j, JAGS Java bindings)
  - [x] Implement internal HMC sampler (unconstrained reparam + Jacobian)
  - [x] Env-based tuning knobs for `stepSize`/`leapfrogSteps` (HMC_STEP_SIZE/HMC_LEAP)
  - [x] Dual-averaging step-size adaptation to target 0.65‚Äì0.80 acceptance
  - [x] Diagonal mass-matrix adaptation (momentum preconditioning)
  - [ ] Dynamic trajectory length (NUTS-style)
  - [x] Simple divergence checks (energy error, non-finite H) in HMC
  - [x] Multi-chain runner: warmup schedule, seed control (PHI64 spacing), persistent draws (JSONL/meta), summary JSON
  - [x] Metrics export from multi-chain: per-chain acceptance/divergences/Œµ; diagnostics gauges (RÃÇ)
  - [x] Analytic gradient for SteinGradLogP (replace finite-diff; reuse dlogPost)
  - [x] Switch Stein to z-space origin (logit/exp) with Jacobian-corrected score; expose `gradLogTargetZ` and use prepared, thresholded parallel gradients
  - [ ] CLI flags for HMC params (override env)
  - [x] JSON summary output for HMC runs
  - [x] Implement proper log-prior calculations for all parameters
  - [x] Add convergence diagnostics and effective sample size calculations (prototype)
  - [x] Add parallel sampling support (independent MH chains)
  - [x] Add decision voting with explicit overrides wired to policy gates
  - [x] Implement agent presets (safetyCritical, fastPath, consensus) with smoke tests

### Audit System
- [ ] **Implement persistent audit sinks**
  - [x] Database-backed audit sink (PostgreSQL/MySQL)
  - [x] File-based audit sink with rotation
  - [x] Network audit sink (HTTP/REST) with retry/backoff
  - [x] Add audit record serialization/deserialization (JSON Lines)

### Error Handling & Metrics
- [x] Introduce custom exception hierarchy (`QualiaException`, `ConfigurationException`, `ValidationException`, `NetworkException`, `PersistenceException`, `ComputationException`, `AuditWriteException`)
- [x] Add minimal `ErrorReporter` that logs to stderr and increments metrics
- [x] Wire error reporting into `AuditTrail`, `FileAuditSink`, `HttpAuditSink`
- [x] Add per-component counters (e.g., `audit_write_fail_total`, `http_retry_total`, `audit_rotate_total`, `http_audit_post_success_total`, `http_audit_post_fail_total`)
- [x] Export HMC multi-chain metrics in runner (per-chain gauges, total divergences, diagnostics)
- [ ] Expose `MetricsRegistry.toPrometheus()` via a tiny HTTP endpoint (optional)
- [ ] Add unit tests for error paths (file open failure, HTTP 5xx retries, emit fail-open)

### Testing & Validation
- [ ] **Comprehensive test suite**
  - [ ] Unit tests for all model components
  - [ ] Integration tests for audit pipeline
  - [ ] DI factory/service locator unit tests (construction, overrides, error paths)
  - [ ] Gradient check: `gradientLogPosterior` vs. finite-diff (tolerance 1e-5)
  - [ ] HMC regression: acceptance in target band under default seeds
  - [ ] Diagnostics: RÃÇ close to 1 and ESS reasonable on synthetic data
  - [ ] MC vs Stein c_N sanity check on toy integrands
  - [ ] Performance benchmarks
  - [ ] Property-based testing with QuickCheck-style library
  - [ ] Tests for VotingPolicy (override precedence, weighted majorities, ties)
  - [ ] Unit tests for AgentPresets rule stacks
  - [ ] Prepared-cache unit tests: LRU eviction order, TTL expiry, maxEntries enforcement
  - [ ] Weight-based eviction tests with custom weigher
  - [ ] Disk store round-trip: write/read of `Prepared` and header/version checks
  - [ ] Disk corruption/partial-file handling: fallback to compute and re-write
  - [ ] Concurrency: single-flight ensures one compute under load (stress with threads)
  - [ ] Integration: read-through/write-back path exercised via `precompute(...)` and stats validated
  - [ ] Multi-chain runner: reproducibility (seed spacing), output format validation (JSONL/meta/summary), RÃÇ/ESS sanity
  - [x] Remove temporary FAIL prints from `PsiMcdaTest` or keep for triage (set to assertions)

## üîß Medium Priority

### Model Enhancements
- [ ] **Add model diagnostics**
  - [ ] Parameter sensitivity analysis
  - [ ] Model comparison metrics (WAIC, LOO-CV)
  - [ ] Posterior predictive checks
  - [ ] Convergence monitoring

### Data Management
- [ ] **Claim data persistence**
  - [ ] Database schema for claims
  - [ ] Batch processing capabilities
  - [ ] Data validation pipeline
  - [ ] Import/export utilities

### Configuration & Deployment
- [ ] **Configuration management**
  - [ ] YAML/JSON configuration files
  - [ ] Environment variable support
  - [ ] Runtime parameter tuning
  - [ ] Model versioning
  - [ ] DI from env: `AUDIT_SINK={console|file|http|jdbc}`, `AUDIT_DIR`, `AUDIT_HTTP_URL`, `JDBC_URL`, etc.
  - [ ] Provide sane defaults and validation for DI env settings
  - [ ] Cache knobs: PREP cache `maxEntries`, `ttl`, `maxWeightBytes`, disk directory
  - [ ] Feature flags: enable/disable disk layer; enable/disable in-memory layer
  - [ ] Sanity clamps and defaults for cache settings

- [x] Scripts/automation: add `scripts/test_qualia.sh` and `make test-qualia`

## üìä Low Priority

### Monitoring & Observability
- [ ] **Add comprehensive logging**
  - [ ] Structured logging with SLF4J
  - [x] Metrics collection (Prometheus) ‚Äî minimal in-process registry
  - [ ] Distributed tracing
  - [ ] Health checks
  - [x] Basic health checks (sinks)
  - [ ] Export cache stats (hits, misses, loads, load failures, evictions, load time) to metrics registry
  - [ ] Periodic operational log of cache stats and disk store size

### Documentation
- [ ] **API documentation**
  - [x] JavaDoc for all public APIs
  - [ ] User guide with examples
  - [x] Mathematical model documentation
  - [x] Architecture diagrams
  - [ ] HMC usage notes (env flags, targets, diagnostics)
  - [ ] Public Methods API (Œ® + MCDA)
    - [x] computePsi(S,N,Œ±,Ra,Rv,Œª1,Œª2,Œ≤) ‚Üí {psi,O,pen,post}; contracts and examples
    - [x] computePsiTemporal(w,timeSeries,aggregator) ‚Üí psiBar; mean/softcap
    - [x] thresholdTransfer(Œ∫,œÑ,mode) ‚Üí œÑ‚Ä≤; subcap/softcap mapping
    - [x] normalizeCriterion(values,direction) ‚Üí z‚àà[0,1]
    - [x] mapGovernanceWeights(baseWeights,gŒ®,Œ∑) ‚Üí w (Œî^m)
    - [x] gateByPsi(alternatives,œàLower,œÑ) ‚Üí feasible set
    - [x] wsmScore(w,z) / wsmScoreRobust(w,zLower)
    - [x] wpmScore(w,z) / wpmScoreRobust(w,zLower)
    - [x] topsisScore(w,z,dir)
    - [x] ahpWeights(pairwise) ‚Üí {w,CR}
    - [ ] outrankingFlows(Pj,w) / outrankingFlowsRobust(...)
    - [x] zBoundsFromXBounds(xLower,xUpper,direction)
    - [x] sensitivities: gradWSM, gradPsi partials
    - [x] tieBreak(alternatives, keys) ‚Üí winner (lexicographic)
    - [ ] auditTrail(event,payload) ‚Üí recordId (usage + guarantees)
    - [ ] invariants/contracts (ranges, determinism) and complexity notes
    - [ ] error handling semantics (degenerate normalization, floors)
    - [ ] unit tests for all public methods
  - [ ] Caching guide: in-memory LRU + TTL + max-weight + disk layer, configuration, and ops
  - [ ] Disk format doc for `DatasetPreparedDiskStore` and compatibility/versioning policy
    - [x] sanity unit tests for PsiMcda methods (determinism, ranges, known cases)

### MCDA Implementation
- [x] Implement WSM/WPM/TOPSIS ranking with Œ® gating demo
 - [x] Implement AHP pairwise weights and consistency ratio
- [ ] Implement outranking flows (PROMETHEE-like) with monotone Œ® channel
- [ ] Add robust variants (floors/intervals) for WSM/WPM/TOPSIS

### Configuration & Deployment
- [ ] CLI command(s) to run HMC/MCDA demos with JSON output
- [ ] CI: REUSE/license check + build + run HMC acceptance sanity + MCDA demo
- [ ] Release notes template (diagnostics reported, params)

### Performance Optimization
- [ ] **Performance improvements**
  - [x] Memory usage optimization
  - [x] Parallel computation for large datasets
  - [x] Caching strategies
  - [x] Prepared dataset cache: in-memory LRU with TTL and weight-based eviction plus disk write-through (`DatasetPreparedDiskStore`)
  - [ ] JVM tuning recommendations
  - [ ] Benchmarks: compute vs cache-hit latency; throughput under concurrent load
  - [ ] Evaluate Caffeine integration as a drop-in for advanced eviction policies

## üß™ Research & Exploration

### Advanced Features
- [ ] **Model extensions**
  - [ ] Hierarchical models for multiple data sources
  - [ ] Time-varying parameters
  - [ ] Causal inference integration
  - [ ] Uncertainty quantification

### Integration
- [ ] **External system integration**
  - [ ] REST API for model serving
  - [ ] gRPC interface
  - [ ] Message queue integration (Kafka/RabbitMQ)
  - [ ] Cloud deployment (AWS/GCP/Azure)

## üêõ Bug Fixes & Technical Debt

### Code Quality
- [ ] **Code improvements**
  - [ ] Add missing null checks
  - [ ] Improve error messages
  - [ ] Add input validation
  - [ ] Refactor complex methods
  - [ ] Verify immutability/defensive copies for cached values; document contracts
  - [ ] Add `invalidateByDatasetId(id)` convenience and targeted invalidation utilities

### Dependencies
- [ ] **Dependency management**
  - [ ] Update to latest Java version
  - [ ] Review and update dependencies
  - [ ] Add dependency vulnerability scanning
  - [ ] Optimize dependency tree

## üìã Completed Tasks

### ‚úÖ Done
- [x] Basic `ClaimData` record implementation
- [x] `ModelParameters` and `ModelPriors` records
- [x] Core `HierarchicalBayesianModel` structure
- [x] Audit system interfaces and basic implementation
- [x] Console audit sink implementation
- [x] Package consolidation to `qualia` and removal of legacy `core.java`
- [x] Detailed JavaDoc across public APIs
- [x] Voting/override framework and agent presets implemented

---

## Notes

- **Priority levels**: High = blocking, Medium = important, Low = nice-to-have
- **Estimated effort**: Use story points or time estimates
- **Dependencies**: Note which tasks depend on others
- **Review frequency**: Update this TODO weekly

## Quick Commands

```bash
# One-shot Psi + sinks tests
make test-qualia
```


